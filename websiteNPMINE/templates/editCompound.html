{% extends "layout.html" %}
{% from 'macros.html' import add_checkpoint, chemdraw, error_message, warning_message %}
{% block title %}NPMINE | Edit Compound{% endblock %}
{% block bannercontent %}
<!-- Banner -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='jsme/jsme/jsa.css') }}">

{% include 'components/navbar.html' %}
{% include 'components/main-banner.html' %}

<div>
    <div class="container">
      <br><br>
      <h2>Edit Compound: {{ compound.compound_name }}</h2>
      <br>
      <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#historyModal">
          View History
        </button>
      </div>

      <div id="manualInput" style="display:block;">
          <form method="POST" action="{{ url_for('compounds.edit_compound', id=compound.id) }}">
              {{ form.hidden_tag() }}

              <div class="form-group">{{ form.journal.label }} {{ form.journal(class="form-control") }}</div>
              <div class="form-group">{{ form.compound_name.label }} {{ form.compound_name(class="form-control") }}</div>
              <div class="form-group">{{ form.smiles.label }} {{ form.smiles(class="form-control", id="smilesInput") }}</div>

              <div id="jsmeEditor" style="display:block;">
                <h3>Draw Structure</h3>
                  <div id="jsme_container" style="width: 500px; height: 400px; border: 1px solid black;"></div>
                <br>
                <button id="convertToSmiles" type="button" class="btn btn-outline-dark">Generate SMILES</button>
                <br>
                <br>
            </div>

              <div class="form-group">{{ form.class_results.label }} {{ form.class_results(class="form-control") }}</div>
              <div class="form-group">{{ form.superclass_results.label }} {{ form.superclass_results(class="form-control") }}</div>
              <div class="form-group">{{ form.inchi_key.label }} {{ form.inchi_key(class="form-control") }}</div>
              <div class="form-group">{{ form.pathway_results.label }} {{ form.pathway_results(class="form-control") }}</div>
              <div class="form-group">{{ form.isglycoside.label }} {{ form.isglycoside(class="form-control") }}</div>
              <div class="form-group">{{ form.pubchem_id.label }} {{ form.pubchem_id(class="form-control") }}</div>
              <div class="form-group">{{ form.article_url.label }} {{ form.article_url(class="form-control") }}</div>
              <div class="form-group">{{ form.ispublic.label }} {{ form.ispublic(class="form-control") }}</div>

              <!-- DOIs Section -->
              <h3>DOIs</h3>
              <div id="dois">
                  {% for doi_form in form.dois %}
                      <div class="form-group">{{ doi_form.doi.label }} {{ doi_form.doi(class="form-control") }}</div>
                  {% endfor %}
              </div>

              <!-- Taxa Section -->
              <h3>Taxa</h3>
              <div id="taxa">
                  {% for taxon_form in form.taxa %}
                      <div class="form-group">{{ taxon_form.verbatim.label }} {{ taxon_form.verbatim(class="form-control") }}</div>
                  {% endfor %}
              </div>

              <div class="form-group">{{ form.submit(class="btn btn-primary") }}</div>
          </form>

          <form method="POST" action="{{ url_for('compounds.delete_compound', id=compound.id) }}" onsubmit="return confirm('Are you sure you want to delete this compound?');">
              <button type="submit" class="btn btn-danger">Delete Compound</button>
          </form>
      </div>
  </div>

  <div class="modal fade" id="historyModal" tabindex="-1" role="dialog" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document"> <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalLabel">Version History for {{ compound.compound_name }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {% if history_records %}
            <div class="accordion" id="historyAccordion">
              {% for history in history_records %}
                <div class="card">
                  <div class="card-header" id="heading-{{ history.id }}">
                    <h2 class="mb-0">
                      <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse-{{ history.id }}" aria-expanded="true" aria-controls="collapse-{{ history.id }}">
                        Version from: {{ history.created_at.strftime('%Y-%m-%d %H:%M:%S') }} UTC
                      </button>
                    </h2>
                  </div>
                  <div class="card-footer text-right">
                    <form method="POST" action="{{ url_for('compounds.revert_compound', history_id=history.id) }}" onsubmit="return confirm('Are you sure you want to revert to this version? The current data will be saved as a new version.');">
                        
                        {{ form.hidden_tag() }}

                        <button type="submit" class="btn btn-sm btn-info">Set Active</button>
                    </form>
                  </div>
                  <div id="collapse-{{ history.id }}" class="collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading-{{ history.id }}" data-parent="#historyAccordion">
                    <div class="card-body">
                      <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>SMILES:</strong> <code>{{ history.smiles or 'N/A' }}</code></li>
                        <li class="list-group-item"><strong>InChI:</strong> <code>{{ history.inchi or 'N/A' }}</code></li>
                        <li class="list-group-item"><strong>InChI Key:</strong> <code>{{ history.inchi_key or 'N/A' }}</code></li>
                        <li class="list-group-item"><strong>PubChem ID:</strong> {{ history.pubchem_id or 'N/A' }}</li>
                        <li class="list-group-item"><strong>Exact Molecular Weight:</strong> {{ history.exact_molecular_weight or 'N/A' }}</li>
                        
                        <li class="list-group-item"><strong>Journal:</strong> {{ history.journal or 'N/A' }}</li>
                        <li class="list-group-item"><strong>Article URL:</strong> <a href="{{ history.article_url }}" target="_blank" rel="noopener noreferrer">{{ history.article_url or 'N/A' }}</a></li>

                        <li class="list-group-item"><strong>Superclass:</strong> {{ history.superclass_results or 'N/A' }}</li>
                        <li class="list-group-item"><strong>Class:</strong> {{ history.class_results or 'N/A' }}</li>
                        <li class="list-group-item"><strong>Pathway:</strong> {{ history.pathway_results or 'N/A' }}</li>

                        <li class="list-group-item"><strong>Active:</strong> {% if history.active %}Yes{% else %}No{% endif %}</li>
                        <li class="list-group-item"><strong>Source:</strong> {{ history.source or 'N/A' }}</li>
                        <li class="list-group-item"><strong>Version Updated At:</strong> {% if history.updated_at %}{{ history.updated_at.strftime('%Y-%m-%d %H:%M:%S') }} UTC{% else %}N/A{% endif %}</li>
                      </ul>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p>No history found for this compound.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


  <script src="{{ url_for('static', filename='jsme/jsme/jsme.nocache.js') }}"></script>

  <script type="text/javascript">
      function jsmeOnLoad() {
        const smilesString = "{{ compound.smiles | default('', true) }}";

        jsmeApplet = new JSApplet.JSME("jsme_container", "500px", "400px", {
          smiles: smilesString,
        });
      };

      function setJsmeSmiles(newSmiles) {
          if (jsmeApplet) {
              jsmeApplet.setSmiles(newSmiles);
          } else {
              console.error("JSME applet not initialized yet. Cannot set SMILES.");
          }
      };

       document.addEventListener('DOMContentLoaded', function () {
          document.getElementById('convertToSmiles').addEventListener('click', function () {
              if (jsmeApplet) { 
                  var smiles = jsmeApplet.smiles();
                  console.log('currentSmiles', smiles)
                  if (smiles) {
                      document.getElementById('smilesInput').value = smiles;
                  } else {
                      alert('Please draw a molecule first.');
                  }
              } else {
                  console.error("JSME applet not initialized yet.");
              }
          });
      });
  </script>
  <br><br>
<br>
<br>
{% include 'components/footer.html' %}
{% endblock bannercontent %}